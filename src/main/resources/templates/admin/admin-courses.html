<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen Kursus - Admin Dikoding Muda</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}" />
    <link rel="stylesheet" th:href="@{/css/admin-dashboard.css}" />
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

        <!-- Sidebar Fragment -->
        <th:block th:replace="~{admin/fragments/admin-sidebar :: sidebar('courses')}"></th:block>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header Fragment -->
            <th:block th:replace="~{admin/fragments/admin-header :: header('Manajemen Kursus')}"></th:block>

            <!-- Content Area -->
            <div class="content-area">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Daftar Kursus</h3>
                    </div>
                    <div class="card-body">
                        <!-- Toolbar -->
                        <div class="toolbar">
                            <div class="search-box">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"></circle>
                                    <path d="m21 21-4.3-4.3"></path>
                                </svg>
                                <input type="text" id="courseSearch" placeholder="Cari kursus..." onkeyup="filterTable('coursesTable', this.value)">
                            </div>
                            <div class="filter-group">
                                <select class="form-select form-select-sm" id="courseStatusFilter" onchange="filterByStatus('coursesTable', this.value)">
                                    <option value="">Semua Status</option>
                                    <option value="published">Published</option>
                                    <option value="draft">Draft</option>
                                    <option value="suspended">Suspended</option>
                                </select>
                                <select class="form-select form-select-sm" id="courseCategoryFilter" onchange="filterByCategory('coursesTable', this.value)">
                                    <option value="">Semua Kategori</option>
                                    <option th:each="cat : ${categories}" th:value="${cat.name}" th:text="${cat.name}">Kategori</option>
                                </select>
                            </div>
                        </div>

                        <!-- Table -->
                        <div class="table-responsive">
                            <table class="table table-hover" id="coursesTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Kursus</th>
                                        <th>Kategori</th>
                                        <th>Harga</th>
                                        <th>Enrollments</th>
                                        <th>Status</th>
                                        <th>Dibuat</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="course : ${courses}" 
                                        th:data-status="${course.status}"
                                        th:data-category="${course.category.name}">
                                        <td>
                                            <div class="table-course">
                                                <div class="table-course-info">
                                                    <div class="table-course-title" th:text="${course.title}">Judul Kursus</div>
                                                    <div class="table-course-instructor" th:text="${course.lecturer.firstName + ' ' + course.lecturer.lastName}">Nama Pengajar</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge bg-light text-dark" th:text="${course.category.name}">Kategori</span>
                                        </td>
                                        <td th:text="${course.price == 0 ? 'Gratis' : 'Rp ' + #numbers.formatInteger(course.price, 3, 'POINT')}">Rp 0</td>
                                        <td th:text="${course.enrollmentCount != null ? course.enrollmentCount : 0}">0</td>
                                        <td>
                                            <span class="status-badge" th:classappend="${course.status}" th:text="${course.status}">status</span>
                                        </td>
                                        <td th:text="${#temporals.format(course.createdAt, 'dd MMM yyyy')}">01 Jan 2025</td>
                                        <td>
                                            <div class="action-btns">
                                                <button class="action-btn"
                                                        th:data-id="${course.courseId}"
                                                        onclick="viewCourse(this.getAttribute('data-id'))"
                                                        title="Lihat Detail">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                                        <circle cx="12" cy="12" r="3"></circle>
                                                    </svg>
                                                </button>

                                                <button class="action-btn edit"
                                                        th:data-id="${course.courseId}"
                                                        th:data-status="${course.status}"
                                                        onclick="editCourseStatus(this.getAttribute('data-id'), this.getAttribute('data-status'))"
                                                        title="Edit Status">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                    </svg>
                                                </button>

                                                <button class="action-btn delete"
                                                        th:data-id="${course.courseId}"
                                                        onclick="deleteItem('course', this.getAttribute('data-id'))"
                                                        title="Hapus">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <polyline points="3 6 5 6 21 6"></polyline>
                                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <!-- Empty state -->
                                    <tr th:if="${courses == null || courses.isEmpty()}">
                                        <td colspan="7" class="text-center py-4 text-muted">Belum ada kursus</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <nav th:if="${totalPages != null && totalPages > 1}">
                            <ul class="pagination justify-content-center mb-0">
                                <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                                    <a class="page-link" th:href="@{/admin/courses(page=${currentPage - 1})}">Sebelumnya</a>
                                </li>
                                <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}" th:classappend="${i == currentPage} ? 'active'">
                                    <a class="page-link" th:href="@{/admin/courses(page=${i})}" th:text="${i + 1}">1</a>
                                </li>
                                <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                                    <a class="page-link" th:href="@{/admin/courses(page=${currentPage + 1})}">Selanjutnya</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- Course Status Modal -->
    <th:block th:replace="~{admin/fragments/admin-modals :: courseStatusModal}"></th:block>

    <!-- Delete Modal -->
    <th:block th:replace="~{admin/fragments/admin-modals :: deleteModal}"></th:block>

    <!-- Toast Container -->
    <th:block th:replace="~{admin/fragments/admin-modals :: toastContainer}"></th:block>

    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>
    <script th:src="@{/js/admin-common.js}"></script>
    <script>
        // Course-specific functions
        function viewCourse(courseId) {
            window.location.href = '/courses/' + courseId;
        }

        function editCourseStatus(courseId, currentStatus) {
            document.getElementById('courseStatusId').value = courseId;
            document.getElementById('courseStatusValue').value = currentStatus;
            openModal('courseStatusModal');
        }

        function saveCourseStatus() {
            const courseId = document.getElementById('courseStatusId').value;
            const status = document.getElementById('courseStatusValue').value;
            
            fetch('/api/admin/courses/' + courseId + '/status', { 
                method: 'PUT', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ status: status }) 
            })
            .then(response => { 
                if (response.ok) { 
                    showToast('Status berhasil diubah', 'success'); 
                    closeModal('courseStatusModal'); 
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showToast('Gagal mengubah status', 'error'); 
                }
            })
            .catch(error => {
                showToast('Terjadi kesalahan', 'error');
            });
        }

        function filterByCategory(tableId, category) {
            const rows = document.querySelectorAll('#' + tableId + ' tbody tr');
            rows.forEach(row => {
                const rowCategory = row.getAttribute('data-category');
                row.style.display = !category || rowCategory === category ? '' : 'none';
            });
        }
    </script>
</body>
</html>
